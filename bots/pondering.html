<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thing-GPT</title>
  <link rel="stylesheet" href="/styles/ogstyle.css">
  <meta name="google-adsense-account" content="ca-pub-6553820111354942">
  <style>
    .hidden-thought {
      display: none;
    }
    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>


  <h2>Test Chat</h2>

  <!-- Main Chat Section -->
  <div id="chatWindow"></div>

  <!-- Side Panel for Prompt -->
  <div class="side-panel">
    <h3>AI Prompt</h3>
    <textarea id="promptInput" placeholder="Enter prompt for the AI..."></textarea>
    <button id="applyPromptBtn">Apply Prompt</button>
    <button id="clearBtn" class="clear-btn">Clear Chat</button>
  </div>

  <!-- Input Section below chat window -->
  <div class="input-section">
    <input type="text" id="myText" placeholder="Type a message...">
    <button id="sendBtn" disabled>Send</button>
  </div>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6553820111354942"
     crossorigin="anonymous"></script>

  <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6553820111354942"
     data-ad-slot="9416953881"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  <script>
     (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

  <script type="module">
    import Groq from "https://esm.sh/groq-sdk";
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    
    const supabaseUrl = "https://qcdmvyhxhkwkvmrvtfhd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZG12eWh4aGt3a3ZtcnZ0ZmhkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDI0MjQ2OCwiZXhwIjoyMDU5ODE4NDY4fQ.4KLPIJqE_TsNVnM5-sdBaaVOQHYQJNkMfwcB17_1zzQ";
    const supabaseClient = createClient(supabaseUrl, supabaseKey);
    const chatWindow = document.getElementById("chatWindow");
    const inputField = document.getElementById("myText");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const applyPromptBtn = document.getElementById("applyPromptBtn");
    const promptInput = document.getElementById("promptInput");

    let apiKey = null;

    async function loadGroqKey() {
      try {
        const res = await fetch('https://thinggptapi.vercel.app/plaintext.js', {
          cache: 'no-store',
          method: 'GET',
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        apiKey = (await res.text()).trim();
        console.log('Groq key loaded successfully');
        sendBtn.disabled = false; // Enable the send button once the key is loaded
      } catch (err) {
        console.error('Could not load Groq key:', err);
        addMessage("system", "Error: Failed to load API key. Please try refreshing the page.");
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadGroqKey();
      
      let conversationHistory = JSON.parse(localStorage.getItem("chatHistoryP")) || [];
      let aiPrompt = localStorage.getItem("aiPrompt") || "";
      promptInput.value = aiPrompt; // Initialize prompt input with stored value
      renderHistory(conversationHistory);

      inputField.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendBtn.click();
        }
      });

      applyPromptBtn.addEventListener("click", () => {
        aiPrompt = promptInput.value.trim();
        localStorage.setItem("aiPrompt", aiPrompt);
        localStorage.removeItem("chatHistoryP");
        conversationHistory = [];
        chatWindow.innerHTML = "";
        addMessage("system", `AI Prompt updated: "${aiPrompt}"`);
      });

sendBtn.addEventListener("click", async () => {
  const userText = inputField.value.trim();
  if (!userText) return;
  if (!apiKey) {
    addMessage("system", "Error: API key not loaded. Please try again later.");
    return;
  }

  addMessage("user", userText);
  inputField.value = "";

  const groq = new Groq({ apiKey, dangerouslyAllowBrowser: true });

  // Persona prompts
  const proPrompt = "You are AI #1. Always argue in favor of the topic.";
  const conPrompt = "You are AI #2. Always argue against the topic.";

  let lastMessage = userText;

  for (let i = 0; i < 10; i++) { 
    const currentPrompt = i % 2 === 0 ? proPrompt : conPrompt;
    const role = i % 2 === 0 ? "AI #1" : "AI #2";

    try {
      const messages = [
        { role: "system", content: currentPrompt },
        { role: "user", content: lastMessage }
      ];

      const result = await groq.chat.completions.create({
        messages,
        model: "llama-3.3-70b-versatile",
      });

      const aiResponse = result.choices[0]?.message?.content || "No response.";
      addMessage("assistant", `[${role}] ${aiResponse}`);

      lastMessage = aiResponse; // pass this to the next AI
    } catch (err) {
      console.error(err);
      addMessage("assistant", `[${role}] [Error getting response.]`);
      break;
    }
  }
});

      clearBtn.addEventListener("click", () => {
        localStorage.removeItem("chatHistoryP");
        localStorage.removeItem("aiPrompt");
        conversationHistory = [];
        aiPrompt = "";
        promptInput.value = "";
        chatWindow.innerHTML = "";
      });


          async function addMessage(role, content) {
        const msg = { role, content };
        conversationHistory.push(msg);
        console.log(content);
        localStorage.setItem("chatHistoryP", JSON.stringify(conversationHistory));
        chatWindow.appendChild(createMessageBubble(msg));
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
          const { error } = await supabaseClient.from("chat_logs").insert([{ role, content }]);
          if (error) {
            console.error("Failed to log message to Supabase:", error);
          }
        } catch (err) {
          console.error("Error inserting into Supabase:", err);
        }
      }

      function renderHistory(history) {
        history.forEach((msg) => {
          chatWindow.appendChild(createMessageBubble(msg));
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function createMessageBubble({ role, content }) {
        const div = document.createElement("div");
        div.className = role === "user" ? "user-bubble" : "ai-bubble";
        
        let processedContent = "";
        
        if (role === "assistant") {
          const lines = content.split(/\n/);
          for (let line of lines) {
            if (line.startsWith("#")) {
              processedContent += `<span class="hidden-thought">${line}</span>`;
            } else {
              let lineContent = line.replace(/\*([^*]+)\*/g, "<em>$1</em>");
              lineContent = lineContent.replace(/:trol:/g, '<img src="/img/trollface.png" alt="troll" class="chat-emoji" width="24" height="24">');
              processedContent += lineContent + "\n";
            }
          }
        } else {
          processedContent = content.replace(/\*([^*]+)\*/g, "<em>$1</em>");
          processedContent = processedContent.replace(/:trol:/g, '<img src="/img/trollface.png" alt="troll" class="chat-emoji" width="24" height="24">');
        }
        
        div.innerHTML = processedContent;
        return div;
      }

      
    });
  </script>
</body>
</html>