<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thing Chat</title>
  <link rel="stylesheet" href="/styles/ogstyle.css">
  <meta name="google-adsense-account" content="ca-pub-6553820111354942">
  <style>
    .hidden-thought {
      display: none;
    }
    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .user-bubble {
      background: #0078ff;
      color: white;
      padding: 10px;
      margin: 8px;
      border-radius: 10px;
      max-width: 60%;
      align-self: flex-end;
    }
    .ai-bubble {
      background: #e5e5ea;
      color: black;
      padding: 10px;
      margin: 8px;
      border-radius: 10px;
      max-width: 60%;
      align-self: flex-start;
    }
    #chatWindow {
      border: 1px solid #ccc;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
      display: flex;
      flex-direction: column;
    }
    .input-section {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    #myText {
      flex: 1;
      padding: 8px;
    }
  </style>
</head>
<body>
  <!-- Disclaimer Overlay -->
  <div id="disclaimerOverlay">
    <div id="disclaimerContent">
      <p>
        By using this service, you agree to our
        <a href="tos" target="_blank">Terms of Service</a> and
        <a href="PrPy" target="_blank">Privacy Policy</a>.
      </p>
      <button id="dismissDisclaimer">OKAY</button>
    </div>
  </div>

  <h2>Thing Chat</h2>

  <!-- Main Chat Section -->
  <div id="chatWindow"></div>

  <!-- Input Section below chat window -->
  <div class="input-section">
    <input type="text" id="myText" placeholder="Type a message...">
    <button id="sendBtn" value="send">Send</button>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Initialize Supabase
    const supabaseClient = createClient(
      'https://ylfnsodkmjyzqwkjqzaf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsZm5zb2RrbWp5enF3a2pxemFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MjY5MzIsImV4cCI6MjA3MDIwMjkzMn0.s_x9Jjc5Qutd6edfxQuSzuLNQY3mBjeH_tYan7lxoJ0'
    );

    const chatWindow = document.getElementById("chatWindow");
    const inputField = document.getElementById("myText");
    const sendBtn = document.getElementById("sendBtn");
    const disclaimerOverlay = document.getElementById("disclaimerOverlay");

    // Generate a unique user ID
    const user_id = localStorage.getItem('id') || '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('id', user_id);
    console.log("User ID:", user_id);

    // Dismiss disclaimer
    document.getElementById("dismissDisclaimer").addEventListener("click", () => {
      disclaimerOverlay.style.display = "none";
    });

    // Send message
    sendBtn.addEventListener("click", createMessage);
    inputField.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        createMessage();
      }
    });

    async function createMessage() {
      const message = inputField.value.trim();
      if (!message) return;

      inputField.value = "";

      try {
        const { error } = await supabaseClient
          .from("ChatLogz")
          .insert([{ user_id, message }]);
        if (error) {
          console.error("Insert error:", error);
        }
      } catch (err) {
        console.error("Unexpected error:", err);
      }
    }

    async function viewMessages() {
      try {
        const { data, error } = await supabaseClient
          .from("ChatLogz")
          .select("*")
          .order("id", { ascending: true });
        if (error) {
          console.error("Select error:", error);
          return;
        }

        renderChat(data);
      } catch (err) {
        console.error("Unexpected error:", err);
      }
    }

    function renderChat(messages) {
      chatWindow.innerHTML = "";
      messages.forEach((row) => {
        const div = document.createElement("div");
        div.className = row.user_id === user_id ? "user-bubble" : "ai-bubble";
        div.innerText = row.user_id + ": " + row.message;
        chatWindow.appendChild(div);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Refresh messages every 500ms
    setInterval(viewMessages, 500);
  </script>
</body>
</html>
