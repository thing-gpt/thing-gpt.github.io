<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thing-GPT</title>
  <link rel="stylesheet" href="/styles/alternative.css">
  <meta name="google-adsense-account" content="ca-pub-6553820111354942">
  <style>
    .hidden-thought {
      display: none;
    }
    .ai1-bubble {
      background-color: #d1f7d6;
      border-left: 4px solid green;
      padding: 6px;
      margin: 4px 0;
    }
    .ai2-bubble {
      background-color: #f7d6d6;
      border-left: 4px solid red;
      padding: 6px;
      margin: 4px 0;
    }
    .user-bubble {
      background-color: #d6e8f7;
      border-left: 4px solid blue;
      padding: 6px;
      margin: 4px 0;
    }
    .system-bubble {
      background-color: #eee;
      border-left: 4px solid gray;
      padding: 6px;
      margin: 4px 0;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h2>Profound Pondering</h2>

  <!-- Main Chat Section -->
  <div id="chatWindow"></div>

  <!-- Side Panel for Prompt -->
  <div class="side-panel">
    <h3>AI Prompts</h3>
    <label for="ai1Prompt">AI #1 Prompt</label>
    <textarea id="ai1Prompt" placeholder="Enter prompt for AI #1..."></textarea>

    <label for="ai2Prompt">AI #2 Prompt</label>
    <textarea id="ai2Prompt" placeholder="Enter prompt for AI #2..."></textarea>

    <button id="applyPromptBtn">Apply Prompts</button>
    <button id="clearBtn" class="clear-btn">Clear Chat</button>
    <button id="stopBtn" class="stop-btn">Stop</button>
  </div>

  <!-- Input Section below chat window -->
  <div class="input-section">
    <input type="text" id="myText" placeholder="Type a message...">
    <button id="sendBtn" disabled>Send</button>
  </div>

  <!-- Adsense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6553820111354942" crossorigin="anonymous"></script>
  <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6553820111354942"
     data-ad-slot="9416953881"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

  <script type="module">
    import Groq from "https://esm.sh/groq-sdk";
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://qcdmvyhxhkwkvmrvtfhd.supabase.co";
    const supabaseKey = "filler"; // replace with your real anon key
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const chatWindow = document.getElementById("chatWindow");
    const inputField = document.getElementById("myText");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const applyPromptBtn = document.getElementById("applyPromptBtn");
    const stopBtn = document.getElementById("stopBtn");

    let apiKey = null;
    let stopRequested = false;

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function loadGroqKey() {
      try {
        const res = await fetch("https://thinggptapi.vercel.app/plaintext.js", {
          cache: "no-store",
          method: "GET",
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        apiKey = (await res.text()).trim();
        console.log("Groq key loaded successfully");
        sendBtn.disabled = false; // enable button when key is ready
      } catch (err) {
        console.error("Could not load Groq key:", err);
        addMessage("system", "Error: Failed to load API key. Please try refreshing the page.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadGroqKey();

      let conversationHistory = JSON.parse(localStorage.getItem("chatHistoryP")) || [];
      let ai1Prompt =
        localStorage.getItem("ai1Prompt") ||
        "You are AI #1. Always argue in favor of the topic. Always have a 'glass half full' way. Support your reasoning with opinions, not facts. Leave your response fairly short. Be full of personality.";

      let ai2Prompt =
        localStorage.getItem("ai2Prompt") ||
        "You are AI #2. Always argue against the topic. Always have a 'glass half empty' way. Support your reasoning with facts and opinions. Leave your response fairly short. Be full of personality.";

      document.getElementById("ai1Prompt").value = ai1Prompt;
      document.getElementById("ai2Prompt").value = ai2Prompt;

      renderHistory(conversationHistory);

      applyPromptBtn.addEventListener("click", () => {
        ai1Prompt = document.getElementById("ai1Prompt").value.trim();
        ai2Prompt = document.getElementById("ai2Prompt").value.trim();
        localStorage.setItem("ai1Prompt", ai1Prompt);
        localStorage.setItem("ai2Prompt", ai2Prompt);
        localStorage.removeItem("chatHistoryP");
        conversationHistory = [];
        chatWindow.innerHTML = "";
        addMessage("system", `Prompts updated for AI #1 and AI #2.`);
      });

      stopBtn.addEventListener("click", () => {
        stopRequested = true;
        addMessage("system", "AI conversation stopped.");
      });

      sendBtn.addEventListener("click", async () => {
        const userText = inputField.value.trim();
        if (!userText) return;
        if (!apiKey) {
          addMessage("system", "Error: API key not loaded. Please try again later.");
          return;
        }

        addMessage("user", userText);
        inputField.value = "";
        stopRequested = false; // reset on each new conversation

        const groq = new Groq({ apiKey, dangerouslyAllowBrowser: true });

        let lastMessage = userText;

        for (let i = 0; i < 10; i++) {
          if (stopRequested) break;

          const currentPrompt = i % 2 === 0 ? ai1Prompt : ai2Prompt;
          const role = i % 2 === 0 ? "AI #1" : "AI #2";

          try {
            const messages = [
              { role: "system", content: currentPrompt },
              { role: "user", content: lastMessage },
            ];

            const result = await groq.chat.completions.create({
              messages,
              model: "llama-3.3-70b-versatile",
            });

            const aiResponse = result.choices[0]?.message?.content || "No response.";
            addMessage("assistant", `[${role}] ${aiResponse}`);

            lastMessage = aiResponse;

            // wait 5â€“10 seconds before next turn
            const delay = 5000 + Math.random() * 5000;
            await sleep(delay);
          } catch (err) {
            console.error(err);
            addMessage("assistant", `[${role}] [Error getting response.]`);
            break;
          }
        }
      });

      clearBtn.addEventListener("click", () => {
        localStorage.removeItem("chatHistoryP");
        localStorage.removeItem("ai1Prompt");
        localStorage.removeItem("ai2Prompt");
        document.getElementById("ai1Prompt").value = "";
        document.getElementById("ai2Prompt").value = "";
        ai1Prompt = "";
        ai2Prompt = "";
        conversationHistory = [];
        chatWindow.innerHTML = "";
      });

      async function addMessage(role, content) {
        const msg = { role, content };
        conversationHistory.push(msg);
        localStorage.setItem("chatHistoryP", JSON.stringify(conversationHistory));
        chatWindow.appendChild(createMessageBubble(msg));
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
          const { error } = await supabaseClient
            .from("chat_logs")
            .insert([{ role, content }]);
          if (error) console.error("Failed to log message to Supabase:", error);
        } catch (err) {
          console.error("Error inserting into Supabase:", err);
        }
      }

      function renderHistory(history) {
        history.forEach((msg) => {
          chatWindow.appendChild(createMessageBubble(msg));
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function createMessageBubble({ role, content }) {
        const div = document.createElement("div");

        if (role === "assistant") {
          if (content.startsWith("[AI #1]")) {
            div.className = "ai1-bubble";
          } else if (content.startsWith("[AI #2]")) {
            div.className = "ai2-bubble";
          } else {
            div.className = "ai-bubble";
          }
        } else if (role === "user") {
          div.className = "user-bubble";
        } else {
          div.className = "system-bubble";
        }

        let displayContent = content.replace(/^\[AI #[12]\]\s*/, "");
        displayContent = displayContent.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        displayContent = displayContent.replace(
          /:trol:/g,
          '<img src="/img/trollface.png" alt="troll" class="chat-emoji" width="24" height="24">'
        );

        div.innerHTML = displayContent;
        return div;
      }
    });
  </script>
</body>
</html>
